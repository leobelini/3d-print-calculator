class a{#o=!0;#e;#t;#u;#n;#h;#i;#a;#c=0;#v=5;#r=!1;#d=!1;#s=null;#g=()=>{this.debugLog("Connected to event bus"),this.#h=!0,this.#r=!1,this.debugLog("Emitting queued events",this.#n),this.#n.forEach(t=>this.emitEventToBus(t)),this.#n=[],this.stopConnectLoop(),this.#t().removeEventListener("tanstack-connect-success",this.#g)};#l=()=>{if(this.#c<this.#v){this.#c++,this.dispatchCustomEvent("tanstack-connect",{});return}this.#t().removeEventListener("tanstack-connect",this.#l),this.#d=!0,this.debugLog("Max retries reached, giving up on connection"),this.stopConnectLoop()};#E=()=>{this.#r||(this.#r=!0,this.#t().addEventListener("tanstack-connect-success",this.#g),this.#l())};constructor({pluginId:t,debug:e=!1,enabled:n=!0,reconnectEveryMs:i=300}){this.#e=t,this.#o=n,this.#t=this.getGlobalTarget,this.#u=e,this.debugLog(" Initializing event subscription for plugin",this.#e),this.#n=[],this.#h=!1,this.#d=!1,this.#i=null,this.#a=i}startConnectLoop(){this.#i!==null||this.#h||(this.debugLog(`Starting connect loop (every ${this.#a}ms)`),this.#i=setInterval(this.#l,this.#a))}stopConnectLoop(){this.#r=!1,this.#i!==null&&(clearInterval(this.#i),this.#i=null,this.#n=[],this.debugLog("Stopped connect loop"))}debugLog(...t){this.#u&&console.log(`ðŸŒ´ [tanstack-devtools:${this.#e}-plugin]`,...t)}getGlobalTarget(){if(typeof globalThis<"u"&&globalThis.__TANSTACK_EVENT_TARGET__)return this.debugLog("Using global event target"),globalThis.__TANSTACK_EVENT_TARGET__;if(typeof window<"u"&&typeof window.addEventListener<"u")return this.debugLog("Using window as event target"),window;const t=typeof EventTarget<"u"?new EventTarget:void 0;return typeof t>"u"||typeof t.addEventListener>"u"?(this.debugLog("No event mechanism available, running in non-web environment"),{addEventListener:()=>{},removeEventListener:()=>{},dispatchEvent:()=>!1}):(this.debugLog("Using new EventTarget as fallback"),t)}getPluginId(){return this.#e}dispatchCustomEventShim(t,e){try{const n=new Event(t,{detail:e});this.#t().dispatchEvent(n)}catch{this.debugLog("Failed to dispatch shim event")}}dispatchCustomEvent(t,e){try{this.#t().dispatchEvent(new CustomEvent(t,{detail:e}))}catch{this.dispatchCustomEventShim(t,e)}}emitEventToBus(t){this.debugLog("Emitting event to client bus",t),this.dispatchCustomEvent("tanstack-dispatch-event",t)}createEventPayload(t,e){return{type:`${this.#e}:${t}`,payload:e,pluginId:this.#e}}emit(t,e){if(!this.#o){this.debugLog("Event bus client is disabled, not emitting event",t,e);return}if(this.#s&&(this.debugLog("Emitting event to internal event target",t,e),this.#s.dispatchEvent(new CustomEvent(`${this.#e}:${t}`,{detail:this.createEventPayload(t,e)}))),this.#d){this.debugLog("Previously failed to connect, not emitting to bus");return}if(!this.#h){this.debugLog("Bus not available, will be pushed as soon as connected"),this.#n.push(this.createEventPayload(t,e)),typeof CustomEvent<"u"&&!this.#r&&(this.#E(),this.startConnectLoop());return}return this.emitEventToBus(this.createEventPayload(t,e))}on(t,e,n){const i=n?.withEventTarget??!1,s=`${this.#e}:${t}`;if(i&&(this.#s||(this.#s=new EventTarget),this.#s.addEventListener(s,o=>{e(o.detail)})),!this.#o)return this.debugLog("Event bus client is disabled, not registering event",s),()=>{};const r=o=>{this.debugLog("Received event from bus",o.detail),e(o.detail)};return this.#t().addEventListener(s,r),this.debugLog("Registered event to bus",s),()=>{i&&this.#s?.removeEventListener(s,r),this.#t().removeEventListener(s,r)}}onAll(t){if(!this.#o)return this.debugLog("Event bus client is disabled, not registering event"),()=>{};const e=n=>{const i=n.detail;t(i)};return this.#t().addEventListener("tanstack-devtools-global",e),()=>this.#t().removeEventListener("tanstack-devtools-global",e)}onAllPluginEvents(t){if(!this.#o)return this.debugLog("Event bus client is disabled, not registering event"),()=>{};const e=n=>{const i=n.detail;this.#e&&i.pluginId!==this.#e||t(i)};return this.#t().addEventListener("tanstack-devtools-global",e),()=>this.#t().removeEventListener("tanstack-devtools-global",e)}}class d extends a{constructor(){super({pluginId:"form-devtools",reconnectEveryMs:1e3})}}const l=new d;export{l as f};
